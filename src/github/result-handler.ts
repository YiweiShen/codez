/**
 * Manage action results: commit changes, create pull requests, or post comments.
 */
import { promises as fs } from 'fs';
import path from 'path';
import * as core from '@actions/core';
import { execa } from 'execa';

import type { ActionConfig } from '../config/config';
import type { ProcessedEvent } from './event';
import { generateCommitMessage as generateCommitMessageOpenAI } from '../api/openai';
import { GitHubError } from '../utils/errors';
import { createPullRequest, commitAndPush } from './git';
import { upsertComment } from './comments';
import { detectChanges } from '../file/file';

/**
 * Process and publish the action's results: push commits, open PR, or post comments.
 * @param config - The ActionConfig with context and clients.
 * @param processedEvent - Normalized event data triggering the action.
 * @param output - The raw text output generated by Codex or fallback.
 * @param changedFiles - List of relative file paths that were modified.
 * @param progressCommentId - Optional ID of the progress comment to update.
 * @returns Promise that resolves when result processing is complete.
 */
export async function handleResult(
  config: ActionConfig,
  processedEvent: ProcessedEvent,
  output: string,
  changedFiles: string[],
  progressCommentId?: number,
): Promise<void> {
  const { octokit, repo, workspace } = config;
  const { agentEvent, userPrompt, noPr } = processedEvent;
  const event = agentEvent.github;
  if (noPr) {
    core.info('Flag --no-pr detected; skipping pull request creation.');
  }

  const workflowFiles = changedFiles.filter((f) =>
    f.startsWith('.github/workflows/'),
  );
  if (workflowFiles.length > 0) {
    core.warning(
      `Ignoring changes to workflow files: ${workflowFiles.join(', ')}`,
    );
    await execa('git', ['checkout', 'HEAD', '--', '.github/workflows'], {
      cwd: workspace,
      stdio: 'inherit',
    });
  }
  const imageFiles = changedFiles.filter((f) =>
    f.startsWith('codex-comment-images/'),
  );
  if (imageFiles.length > 0) {
    core.warning(
      `Ignoring changes to codex-comment-images folder: ${imageFiles.join(
        ', ',
      )}`,
    );
    const imagesDir = path.join(workspace, 'codex-comment-images');
    try {
      await fs.rm(imagesDir, { recursive: true, force: true });
      core.info(`Removed image artifacts directory: ${imagesDir}`);
    } catch (error) {
      core.warning(
        `Failed to remove image artifacts directory: ${
          error instanceof Error ? error.message : String(error)
        }`,
      );
    }
  }
  const effectiveChangedFiles = changedFiles.filter(
    (f) =>
      !f.startsWith('.github/workflows/') &&
      !f.startsWith('codex-comment-images/'),
  );

  if (!noPr && effectiveChangedFiles.length > 0) {
    core.info(
      `Detected changes in ${
        effectiveChangedFiles.length
      } files:\n${effectiveChangedFiles.join('\n')}`,
    );

    const generateCommitMessage = generateCommitMessageOpenAI;
    core.info('[perf] generateCommitMessage start');
    const startGenerateCommitMessage = Date.now();
    const commitMessage = await generateCommitMessage(
      effectiveChangedFiles,
      userPrompt,
      {
        issueNumber:
          agentEvent.type === 'issuesOpened' ||
          agentEvent.type === 'issueCommentCreated' ||
          agentEvent.type === 'issuesAssigned'
            ? agentEvent.github.issue.number
            : undefined,
        prNumber:
          agentEvent.type === 'pullRequestCommentCreated'
            ? agentEvent.github.issue.number
            : agentEvent.type === 'pullRequestReviewCommentCreated'
            ? agentEvent.github.pull_request.number
            : undefined,
      },
      config,
    );
    core.info(
      `[perf] generateCommitMessage end - ${
        Date.now() - startGenerateCommitMessage
      }ms`,
    );

    if (
      agentEvent.type === 'issuesOpened' ||
      agentEvent.type === 'issueCommentCreated' ||
      agentEvent.type === 'issuesAssigned'
    ) {
      await createPullRequest(
        workspace,
        octokit,
        repo,
        agentEvent.github,
        commitMessage,
        output,
        progressCommentId,
      );
    } else if (
      agentEvent.type === 'pullRequestCommentCreated' ||
      agentEvent.type === 'pullRequestReviewCommentCreated'
    ) {
      await commitAndPush(
        workspace,
        octokit,
        repo,
        agentEvent.github,
        commitMessage,
        output,
        progressCommentId,
      );
    }
  } else if (noPr && effectiveChangedFiles.length > 0) {
    core.info(
      `--no-pr flag used and detected changes in ${effectiveChangedFiles.length} files; posting diff in comment.`,
    );
    let diffOutput = '';
    try {
      const { stdout } = await execa(
        'git',
        ['diff', 'HEAD', '--', ...effectiveChangedFiles],
        { cwd: workspace },
      );
      diffOutput = stdout;
    } catch (err) {
      core.warning(
        `Failed to generate diff for comment: ${
          err instanceof Error ? err.message : String(err)
        }`,
      );
    }
    const commentBody = `${output}\n\n**Proposed changes:**\n\`\`\`diff\n${diffOutput}\n\`\`\``;
    await upsertComment(octokit, repo, event, progressCommentId, commentBody);
  } else {
    await upsertComment(octokit, repo, event, progressCommentId, output);
  }
}
